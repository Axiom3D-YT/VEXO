(function () {
    "use strict"; var F, rt; F = { __e: function (t, e, n, s) { for (var i, o, a; e = e.__;)if ((i = e.__c) && !i.__) try { if ((o = i.constructor) && o.getDerivedStateFromError != null && (i.setState(o.getDerivedStateFromError(t)), a = i.__d), i.componentDidCatch != null && (i.componentDidCatch(t, s || {}), a = i.__d), a) return i.__E = i } catch (r) { t = r } throw t } }, rt = function (t) { return t != null && t.constructor === void 0 }, typeof Promise == "function" && Promise.prototype.then.bind(Promise.resolve()); var Q, h, V, lt, ct = 0, dt = [], m = F, ut = m.__b, ft = m.__r, mt = m.diffed, vt = m.__c, gt = m.unmount, yt = m.__; function Xt(t, e) { m.__h && m.__h(h, t, ct || e), ct = 0; var n = h.__H || (h.__H = { __: [], __h: [] }); return t >= n.__.length && n.__.push({}), n.__[t] } function pt(t, e) { var n = Xt(Q++, 7); return te(n.__H, e) && (n.__ = t(), n.__H = e, n.__h = t), n.__ } function Yt() { for (var t; t = dt.shift();)if (t.__P && t.__H) try { t.__H.__h.forEach(W), t.__H.__h.forEach(X), t.__H.__h = [] } catch (e) { t.__H.__h = [], m.__e(e, t.__v) } } m.__b = function (t) { h = null, ut && ut(t) }, m.__ = function (t, e) { t && e.__k && e.__k.__m && (t.__m = e.__k.__m), yt && yt(t, e) }, m.__r = function (t) { ft && ft(t), Q = 0; var e = (h = t.__c).__H; e && (V === h ? (e.__h = [], h.__h = [], e.__.forEach(function (n) { n.__N && (n.__ = n.__N), n.u = n.__N = void 0 })) : (e.__h.forEach(W), e.__h.forEach(X), e.__h = [], Q = 0)), V = h }, m.diffed = function (t) { mt && mt(t); var e = t.__c; e && e.__H && (e.__H.__h.length && (dt.push(e) !== 1 && lt === m.requestAnimationFrame || ((lt = m.requestAnimationFrame) || Kt)(Yt)), e.__H.__.forEach(function (n) { n.u && (n.__H = n.u), n.u = void 0 })), V = h = null }, m.__c = function (t, e) { e.some(function (n) { try { n.__h.forEach(W), n.__h = n.__h.filter(function (s) { return !s.__ || X(s) }) } catch (s) { e.some(function (i) { i.__h && (i.__h = []) }), e = [], m.__e(s, n.__v) } }), vt && vt(t, e) }, m.unmount = function (t) { gt && gt(t); var e, n = t.__c; n && n.__H && (n.__H.__.forEach(function (s) { try { W(s) } catch (i) { e = i } }), n.__H = void 0, e && m.__e(e, n.__v)) }; var ht = typeof requestAnimationFrame == "function"; function Kt(t) { var e, n = function () { clearTimeout(s), ht && cancelAnimationFrame(e), setTimeout(t) }, s = setTimeout(n, 35); ht && (e = requestAnimationFrame(n)) } function W(t) { var e = h, n = t.__c; typeof n == "function" && (t.__c = void 0, n()), h = e } function X(t) { var e = h; t.__c = t.__(), h = e } function te(t, e) { return !t || t.length !== e.length || e.some(function (n, s) { return n !== t[s] }) } var ee = Symbol.for("preact-signals"); function Y() { if (C > 1) C--; else { for (var t, e = !1; N !== void 0;) { var n = N; for (N = void 0, K++; n !== void 0;) { var s = n.o; if (n.o = void 0, n.f &= -3, !(8 & n.f) && wt(n)) try { n.c() } catch (i) { e || (t = i, e = !0) } n = s } } if (K = 0, C--, e) throw t } } var c = void 0; function _t(t) { var e = c; c = void 0; try { return t() } finally { c = e } } var N = void 0, C = 0, K = 0, z = 0; function bt(t) { if (c !== void 0) { var e = t.n; if (e === void 0 || e.t !== c) return e = { i: 0, S: t, p: c.s, n: void 0, t: c, e: void 0, x: void 0, r: e }, c.s !== void 0 && (c.s.n = e), c.s = e, t.n = e, 32 & c.f && t.S(e), e; if (e.i === -1) return e.i = 0, e.n !== void 0 && (e.n.p = e.p, e.p !== void 0 && (e.p.n = e.n), e.p = c.s, e.n = void 0, c.s.n = e, c.s = e), e } } function g(t, e) { this.v = t, this.i = 0, this.n = void 0, this.t = void 0, this.W = e == null ? void 0 : e.watched, this.Z = e == null ? void 0 : e.unwatched, this.name = e == null ? void 0 : e.name } g.prototype.brand = ee, g.prototype.h = function () { return !0 }, g.prototype.S = function (t) { var e = this, n = this.t; n !== t && t.e === void 0 && (t.x = n, this.t = t, n !== void 0 ? n.e = t : _t(function () { var s; (s = e.W) == null || s.call(e) })) }, g.prototype.U = function (t) { var e = this; if (this.t !== void 0) { var n = t.e, s = t.x; n !== void 0 && (n.x = s, t.e = void 0), s !== void 0 && (s.e = n, t.x = void 0), t === this.t && (this.t = s, s === void 0 && _t(function () { var i; (i = e.Z) == null || i.call(e) })) } }, g.prototype.subscribe = function (t) { var e = this; return B(function () { var n = e.value, s = c; c = void 0; try { t(n) } finally { c = s } }, { name: "sub" }) }, g.prototype.valueOf = function () { return this.value }, g.prototype.toString = function () { return this.value + "" }, g.prototype.toJSON = function () { return this.value }, g.prototype.peek = function () { var t = c; c = void 0; try { return this.value } finally { c = t } }, Object.defineProperty(g.prototype, "value", { get: function () { var t = bt(this); return t !== void 0 && (t.i = this.i), this.v }, set: function (t) { if (t !== this.v) { if (K > 100) throw new Error("Cycle detected"); this.v = t, this.i++, z++, C++; try { for (var e = this.t; e !== void 0; e = e.x)e.t.N() } finally { Y() } } } }); function E(t, e) { return new g(t, e) } function wt(t) { for (var e = t.s; e !== void 0; e = e.n)if (e.S.i !== e.i || !e.S.h() || e.S.i !== e.i) return !0; return !1 } function Et(t) { for (var e = t.s; e !== void 0; e = e.n) { var n = e.S.n; if (n !== void 0 && (e.r = n), e.S.n = e, e.i = -1, e.n === void 0) { t.s = e; break } } } function $t(t) { for (var e = t.s, n = void 0; e !== void 0;) { var s = e.p; e.i === -1 ? (e.S.U(e), s !== void 0 && (s.n = e.n), e.n !== void 0 && (e.n.p = s)) : n = e, e.S.n = e.r, e.r !== void 0 && (e.r = void 0), e = s } t.s = n } function x(t, e) { g.call(this, void 0), this.x = t, this.s = void 0, this.g = z - 1, this.f = 4, this.W = e == null ? void 0 : e.watched, this.Z = e == null ? void 0 : e.unwatched, this.name = e == null ? void 0 : e.name } x.prototype = new g, x.prototype.h = function () { if (this.f &= -3, 1 & this.f) return !1; if ((36 & this.f) == 32 || (this.f &= -5, this.g === z)) return !0; if (this.g = z, this.f |= 1, this.i > 0 && !wt(this)) return this.f &= -2, !0; var t = c; try { Et(this), c = this; var e = this.x(); (16 & this.f || this.v !== e || this.i === 0) && (this.v = e, this.f &= -17, this.i++) } catch (n) { this.v = n, this.f |= 16, this.i++ } return c = t, $t(this), this.f &= -2, !0 }, x.prototype.S = function (t) { if (this.t === void 0) { this.f |= 36; for (var e = this.s; e !== void 0; e = e.n)e.S.S(e) } g.prototype.S.call(this, t) }, x.prototype.U = function (t) { if (this.t !== void 0 && (g.prototype.U.call(this, t), this.t === void 0)) { this.f &= -33; for (var e = this.s; e !== void 0; e = e.n)e.S.U(e) } }, x.prototype.N = function () { if (!(2 & this.f)) { this.f |= 6; for (var t = this.t; t !== void 0; t = t.x)t.t.N() } }, Object.defineProperty(x.prototype, "value", { get: function () { if (1 & this.f) throw new Error("Cycle detected"); var t = bt(this); if (this.h(), t !== void 0 && (t.i = this.i), 16 & this.f) throw this.v; return this.v } }); function ne(t, e) { return new x(t, e) } function It(t) { var e = t.u; if (t.u = void 0, typeof e == "function") { C++; var n = c; c = void 0; try { e() } catch (s) { throw t.f &= -2, t.f |= 8, tt(t), s } finally { c = n, Y() } } } function tt(t) { for (var e = t.s; e !== void 0; e = e.n)e.S.U(e); t.x = void 0, t.s = void 0, It(t) } function se(t) { if (c !== this) throw new Error("Out-of-order effect"); $t(this), c = t, this.f &= -2, 8 & this.f && tt(this), Y() } function T(t, e) { this.x = t, this.u = void 0, this.s = void 0, this.o = void 0, this.f = 32, this.name = e == null ? void 0 : e.name } T.prototype.c = function () { var t = this.S(); try { if (8 & this.f || this.x === void 0) return; var e = this.x(); typeof e == "function" && (this.u = e) } finally { t() } }, T.prototype.S = function () { if (1 & this.f) throw new Error("Cycle detected"); this.f |= 1, this.f &= -9, It(this), Et(this), C++; var t = c; return c = this, se.bind(this, t) }, T.prototype.N = function () { 2 & this.f || (this.f |= 2, this.o = N, N = this) }, T.prototype.d = function () { this.f |= 8, 1 & this.f || tt(this) }, T.prototype.dispose = function () { this.d() }; function B(t, e) { var n = new T(t, e); try { n.c() } catch (i) { throw n.d(), i } var s = n.d.bind(n); return s[Symbol.dispose] = s, s } var R; function H(t, e) { F[t] = e.bind(null, F[t] || function () { }) } function J(t) { if (R) { var e = R; R = void 0, e() } R = t && t.S() } function kt(t) { var e = this, n = t.data, s = oe(n); s.value = n; var i = pt(function () { for (var o = e.__v; o = o.__;)if (o.__c) { o.__c.__$f |= 4; break } return e.__$u.c = function () { var a, r = e.__$u.S(), l = i.value; r(), rt(l) || ((a = e.base) == null ? void 0 : a.nodeType) !== 3 ? (e.__$f |= 1, e.setState({})) : e.base.data = l }, ne(function () { var a = s.value.value; return a === 0 ? 0 : a === !0 ? "" : a || "" }) }, []); return i.value } kt.displayName = "_st", Object.defineProperties(g.prototype, { constructor: { configurable: !0, value: void 0 }, type: { configurable: !0, value: kt }, props: { configurable: !0, get: function () { return { data: this } } }, __b: { configurable: !0, value: 1 } }), H("__b", function (t, e) { if (typeof e.type == "string") { var n, s = e.props; for (var i in s) if (i !== "children") { var o = s[i]; o instanceof g && (n || (e.__np = n = {}), n[i] = o, s[i] = o.peek()) } } t(e) }), H("__r", function (t, e) { t(e), J(); var n, s = e.__c; s && (s.__$f &= -2, (n = s.__$u) === void 0 && (s.__$u = n = function (i) { var o; return B(function () { o = this }), o.c = function () { s.__$f |= 1, s.setState({}) }, o }())), J(n) }), H("__e", function (t, e, n, s) { J(), t(e, n, s) }), H("diffed", function (t, e) { J(); var n; if (typeof e.type == "string" && (n = e.__e)) { var s = e.__np, i = e.props; if (s) { var o = n.U; if (o) for (var a in o) { var r = o[a]; r !== void 0 && !(a in s) && (r.d(), o[a] = void 0) } else n.U = o = {}; for (var l in s) { var v = o[l], y = s[l]; v === void 0 ? (v = ie(n, l, y, i), o[l] = v) : v.o(y, i) } } } t(e) }); function ie(t, e, n, s) { var i = e in t && t.ownerSVGElement === void 0, o = E(n); return { o: function (a, r) { o.value = a, s = r }, d: B(function () { var a = o.value.value; s[e] !== a && (s[e] = a, i ? t[e] = a : a ? t.setAttribute(e, a) : t.removeAttribute(e)) }) } } H("unmount", function (t, e) { if (typeof e.type == "string") { var n = e.__e; if (n) { var s = n.U; if (s) { n.U = void 0; for (var i in s) { var o = s[i]; o && o.d() } } } } else { var a = e.__c; if (a) { var r = a.__$u; r && (a.__$u = void 0, r.d()) } } t(e) }), H("__h", function (t, e, n, s) { (s < 3 || s === 9) && (e.__$f |= 2), t(e, n, s) }); function oe(t) { return pt(function () { return E(t) }, []) } const p = { status: "/api/status", guilds: "/api/guilds", guild: t => `/api/guilds/${t}`, settings: t => `/api/guilds/${t}/settings`, analytics: "/api/analytics", users: "/api/users", songs: "/api/songs", library: "/api/library", topSongs: "/api/analytics/top-songs", userPrefs: t => `/api/users/${t}/preferences`, notifications: "/api/notifications", settings_global: "/api/settings/global", leave_guild: t => `/api/guilds/${t}/leave` }, $ = E(null), d = E("global"), q = E([]), M = E(1), et = 50, nt = E({ status: "offline" }), ae = E([]); B(() => { At(), qt() }), B(() => { d.value !== "global" && ot() }), B(() => { Ht(nt.value) }), B(() => { Ot() }), document.addEventListener("DOMContentLoaded", () => { Bt(), Ct(), ot(), qt(), ge(), setInterval(Tt, 5e3), setInterval(it, 1e4), setInterval(At, 15e3), setInterval(ot, 3e4), setInterval(Ee, 15e3), document.querySelectorAll(".tab").forEach(t => { t.addEventListener("click", e => { e.preventDefault(), Z(t.dataset.tab) }) }) }); let S = null, xt = new Set; function Bt() { try { const e = `${window.location.protocol === "https:" ? "wss:" : "ws:"}//${window.location.host}/ws/logs`; console.log(`[Dashboard] Connecting to WebSocket: ${e}`), S = new WebSocket(e), S.onopen = () => { console.log("[Dashboard] WebSocket connected") }, S.onmessage = n => { const s = JSON.parse(n.data); St(s) }, S.onclose = n => { console.warn("[Dashboard] WebSocket closed, retrying in 3s...", n.reason), setTimeout(Bt, 3e3) }, S.onerror = n => console.error("[Dashboard] WebSocket error:", n) } catch (t) { console.error("[Dashboard] WS Init Error", t) } } setInterval(async () => { if (!S || S.readyState !== WebSocket.OPEN) try { const t = await fetch("/api/logs"); if (t.ok) { const e = await t.json(); e.logs && e.logs.forEach(n => St(n)) } } catch (t) { console.error("[Dashboard] Polling failed", t) } }, 1e4); let st = !0; document.addEventListener("DOMContentLoaded", () => { const t = document.getElementById("autoscroll-toggle"); t && t.addEventListener("change", e => { if (st = e.target.checked, st) { const n = document.getElementById("logs"); n && (n.scrollTop = n.scrollHeight) } }) }); function St(t) { const e = document.getElementById("logs"); if (!e) return; const n = e.scrollHeight - e.scrollTop <= e.clientHeight + 100, s = e.children.length === 0, i = `${t.timestamp}-${t.level}-${t.message.substring(0, 50)}`; if (xt.has(i)) return; xt.add(i); const o = new Date(t.timestamp * 1e3).toLocaleTimeString(), a = document.createElement("div"); for (a.className = `log-entry log-${t.level}`, a.innerHTML = `<span class="log-time">${o}</span> [${t.level}] ${t.message}`, e.appendChild(a), st && (n || s) && (e.scrollTop = e.scrollHeight); e.children.length > 500;)e.removeChild(e.firstChild) } async function Lt(t) { if (!t || t === "null" || t === "undefined") return; const e = document.getElementById("user-modal"); if (e) { e.classList.add("open"), le(); try { const s = await (await fetch(`/api/users/${t}/details`)).json(); ce(s) } catch (n) { console.error("Failed to fetch user details", n), document.getElementById("user-modal-content").innerHTML = '<div style="padding: 2rem; text-align: center;">Failed to load profile</div>' } } } function re() { const t = document.getElementById("user-modal"); t && t.classList.remove("open") } function le() { document.getElementById("user-modal-name").innerHTML = '<div class="skeleton skeleton-text" style="width: 150px"></div>', document.getElementById("user-modal-id").innerHTML = '<div class="skeleton skeleton-text" style="width: 100px"></div>', document.getElementById("user-modal-plays").innerHTML = "...", document.getElementById("user-modal-reactions").innerHTML = "...", document.getElementById("user-modal-playlists").innerHTML = "..." } function ce(t) {
        const e = t.user || {}; document.getElementById("user-modal-name").textContent = e.username || "Unknown User", document.getElementById("user-modal-id").textContent = `ID: ${e.id}`, document.getElementById("user-modal-avatar").textContent = (e.username || "?").charAt(0), document.getElementById("user-modal-plays").textContent = t.reactions.length + t.imported_playlists.length * 10, document.getElementById("user-modal-reactions").textContent = t.reactions.length, document.getElementById("user-modal-playlists").textContent = t.imported_playlists.length; const n = document.getElementById("user-modal-reactions-list"); t.reactions.length === 0 ? n.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-muted); padding: 1rem;">No likes yet</td></tr>' : n.innerHTML = t.reactions.map(l => `
            <tr>
                <td>${l.title}</td>
                <td>${l.artist_name}</td>
                <td>${new Date(l.created_at).toLocaleDateString()}</td>
            </tr>
        `).join(""); const s = document.getElementById("user-modal-playlists-list"); t.imported_playlists.length === 0 ? s.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 1rem;">No playlists imported</div>' : s.innerHTML = t.imported_playlists.map(l => `
            <div class="server-nav-item" style="display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border);">
                <span>${l.name || "Untitled Playlist"}</span>
                <span style="font-size: 0.7rem; color: var(--text-muted);">${l.source || "spotify"}</span>
            </div>
        `).join(""); const i = document.getElementById("user-modal-prefs-list"), o = t.preferences || {}; let a = ""; const r = []; for (const [l, v] of Object.entries(o)) for (const [y, L] of Object.entries(v)) r.push({ type: l, key: y, score: L }); r.sort((l, v) => v.score - l.score), r.length === 0 ? a = '<div style="grid-column: span 2; text-align: center; color: var(--text-muted);">No affinity data</div>' : a = r.slice(0, 20).map(l => `
            <div style="background: var(--bg-card); padding: 0.5rem; border-radius: 6px; font-size: 0.8rem; display: flex; justify-content: space-between;">
                <span style="color: var(--text-muted);">${l.type === "genre" ? "üè∑Ô∏è" : "üë®‚Äçüé§"} ${l.key}</span>
                <span style="font-weight: 600;">${l.score.toFixed(1)}</span>
            </div>
        `).join(""), i.innerHTML = a
    } window.viewUser = Lt, window.closeUserModal = re, window.switchModalTab = function (t) { document.querySelectorAll(".modal-tab").forEach(e => e.classList.remove("active")), document.querySelector(`.modal-tab[data-modal-tab="${t}"]`).classList.add("active"), document.querySelectorAll(".modal-tab-pane").forEach(e => e.style.display = "none"), document.getElementById(`modal-${t}`).style.display = "block" }; async function Ct() { de(); try { const e = await (await fetch("/api/dashboard-init")).json(); if (e.status && Ht(e.status), e.guilds && (Mt(e.guilds), d.value !== "global")) { const n = e.guilds.find(s => s.id === d.value); if (n) { const s = document.getElementById("server-stat-members"); s && (s.textContent = n.member_count || 0); const i = document.getElementById("server-stat-queue"); i && (i.textContent = n.queue_size || 0); const o = document.getElementById("server-stat-duration"); o && (o.textContent = `${n.queue_duration || 0}m`) } } Pt(e.guilds), jt(e.guilds), Ut(e.analytics), ae.value = e.notifications, Gt(e.notifications), !$.value && e.guilds.length > 0 && ($.value = e.guilds[0].id), Dt(e.analytics) } catch (t) { console.error("Init failed", t) } } function de() {
        const t = document.getElementById("now-playing"); t && (t.innerHTML = `
        <div class="np-content">
            <div class="skeleton skeleton-artwork"></div>
            <div class="np-info">
                <div class="skeleton skeleton-text" style="width: 60%"></div>
                <div class="skeleton skeleton-text" style="width: 40%"></div>
                <div class="skeleton skeleton-text" style="width: 80%; height: 2rem; margin-top: 1rem;"></div>
            </div>
        </div>
    `), document.querySelectorAll(".stat-value").forEach(n => n.innerHTML = '<span class="skeleton skeleton-text" style="width: 40px; height: 2rem;"></span>')
    } async function Tt() { try { const e = await (await fetch(p.status)).json(); nt.value = e } catch (t) { console.error("Failed to fetch status", t); try { nt.value = { status: "offline" } } catch { } } } function Ht(t) { try { const e = document.querySelector(".status-dot"), n = document.getElementById("status-text"), s = document.getElementById("stat-guilds"), i = document.getElementById("stat-voice"), o = document.getElementById("stat-latency-val"), a = document.getElementById("stat-latency"), r = document.getElementById("stat-cpu"), l = document.getElementById("stat-ram"); e && (e.className = `status-dot status-${t.status === "online" ? "online" : "offline"}`), n && (n.textContent = t.status === "online" ? `Online (${t.latency_ms || 0}ms)` : "Offline"), s && (s.textContent = t.guilds || 0), i && (i.textContent = t.voice_connections || 0), o && (o.textContent = `${t.latency_ms || 0}ms`), a && (a.textContent = `${t.latency_ms || 0}ms`), r && (r.textContent = t.cpu_percent || 0), l && (l.textContent = t.ram_percent || 0); const v = document.getElementById("stat-uptime"); v && (v.textContent = Ft(t.uptime_seconds)) } catch (e) { console.error("Error updating status", e) } } async function it() { try { const e = await (await fetch(p.guilds)).json(); if (!$.value && e.guilds && e.guilds.length > 0 && ($.value = e.guilds[0].id), Mt(e.guilds || []), Pt(e.guilds || []), jt(e.guilds || []), d.value !== "global" && e.guilds) { const n = e.guilds.find(s => s.id === d.value); if (n) { const s = document.getElementById("server-stat-members"); s && (s.textContent = n.member_count || 0); const i = document.getElementById("server-stat-queue"); i && (i.textContent = n.queue_size || 0); const o = document.getElementById("server-stat-duration"); o && (o.textContent = `${n.queue_duration || 0}m`) } } } catch (t) { console.error("Failed to fetch guilds", t) } } function Mt(t) {
        const e = document.getElementById("server-nav"); if (!e) return; let n = `<div class="server-nav-item ${d.value === "global" ? "active" : ""}" onclick="switchScope('global')">Global</div>`; n += t.map(s => `
        <div class="server-nav-item ${d.value === s.id ? "active" : ""}" onclick="switchScope('${s.id}')">
            ${s.name || "Server"}
            ${s.is_playing ? " üîä" : ""}
        </div>
    `).join(""), e.innerHTML = n
    } function Pt(t) {
        const e = document.getElementById("guild-list"); e && (e.innerHTML = t.map(n => `
        <div class="user-item ${n.id === $.value ? "active" : ""}" onclick="selectGuild(event, '${n.id}')">
            <div class="user-avatar">${(n.name || "?").charAt(0)}</div>
            <div class="user-info">
                <div class="user-name">${n.name || "Unknown Server"}</div>
                <div class="user-stats">${n.member_count || 0} members</div>
            </div>
            <div class="user-actions" style="display: flex; gap: 0.5rem; align-items: center;">
                ${n.is_playing ? '<span style="color: var(--success); font-size: 0.8rem;">‚ñ∂ Playing</span>' : ""}
                <button class="btn btn-secondary" style="padding: 0.2rem 0.5rem; font-size: 0.7rem;" onclick="event.stopPropagation(); leaveGuild('${n.id}')">Leave</button>
            </div>
        </div>
    `).join(""))
    } async function ue(t) { if (confirm("Are you sure you want the bot to leave this server?")) try { (await fetch(p.leave_guild(t), { method: "POST" })).ok ? it() : alert("Failed to leave server") } catch (e) { console.error(e), alert("Error leaving server") } } async function fe() { if (!d.value || d.value === "global") return; const t = d.value; if (confirm("Are you sure you want the bot to leave this server? This action is permanent!")) try { (await fetch(p.leave_guild(t), { method: "POST" })).ok ? (alert("Bot has left the server."), at("global"), Ct()) : alert("Failed to leave server") } catch (e) { console.error(e), alert("Error leaving server") } } function jt(t) {
        const e = document.getElementById("now-playing"); if (!e) return; let n = null; if (d.value === "global" ? n = t.find(s => s.is_playing && s.current_song) : n = t.find(s => s.id === d.value && s.is_playing && s.current_song), n) {
            let s = ""; if (n.duration_seconds) { const i = Math.floor(n.duration_seconds / 60), o = n.duration_seconds % 60; s = `${i}:${o.toString().padStart(2, "0")}` } e.innerHTML = `
            <div class="np-content">
                <img class="np-artwork" src="https://img.youtube.com/vi/${n.video_id || "dQw4w9WgXcQ"}/hqdefault.jpg" alt="Album art">
                <div class="np-info">
                    <div class="np-title">${n.current_song || "Unknown"}</div>
                    <div class="np-artist">${n.current_artist || "Unknown Artist"}</div>
                    <div class="np-metadata">
                        ${s ? `<span>‚è≥ ${s}</span>` : ""}
                        ${n.genre ? `<span>üè∑Ô∏è ${n.genre}</span>` : ""}
                        ${n.year ? `<span>üìÖ ${n.year}</span>` : ""}
                    </div>
                    ${n.discovery_reason ? `<div class="np-discovery">${n.discovery_reason}</div>` : ""}
                    <div class="np-controls">
                        <button class="np-btn" onclick="control('pause')">‚è∏Ô∏è</button>
                        <button class="np-btn" onclick="control('skip')">‚è≠Ô∏è</button>
                        <button class="np-btn" onclick="control('stop')">‚èπÔ∏è</button>
                    </div>
                </div>
            </div>
        `, e.style.display = "block"
        } else e.innerHTML = '<div class="np-content" style="justify-content: center;"><span style="color: var(--text-muted);">Nothing playing</span></div>'
    } async function At() { try { let t = p.analytics; d.value !== "global" && (t += `?guild_id=${d.value}`); const n = await (await fetch(t)).json(); Ut(n) } catch (t) { console.error("Failed to fetch analytics", t) } } function Ut(t) {
        var e, n, s, i, o, a, r, l, v; try {
            const y = document.getElementById("stat-songs"), L = document.getElementById("stat-users"), O = document.getElementById("stat-plays"); O && (O.textContent = t.total_plays || 0); const I = document.getElementById("stat-uptime"); I && t.uptime_seconds && (I.textContent = Ft(t.uptime_seconds)), y && (y.textContent = t.total_songs || 0), L && (L.textContent = t.total_users || 0); const _ = document.getElementById("stat-songs-global"); _ && (_.textContent = t.total_songs || 0); const k = document.getElementById("stat-plays-global"); k && (k.textContent = t.total_plays || 0); const b = document.getElementById("stat-users-global"); b && (b.textContent = t.total_users || 0); const w = document.getElementById("top-songs-table"); w && (!t.top_songs || t.top_songs.length === 0 ? w.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-muted); padding: 2rem;">No songs played yet</td></tr>' : w.innerHTML = t.top_songs.slice(0, 10).map((f, U) => `
                    <tr>
                        <td>${U + 1}</td>
                        <td>
                            <div class="song-cell">
                                <img class="song-thumb" src="https://img.youtube.com/vi/${f.yt_id}/default.jpg" alt="">
                                <div class="song-info">
                                    <span class="song-name">${f.title}</span>
                                    <span class="song-artist">${f.artist}</span>
                                </div>
                            </div>
                        </td>
                        <td>${f.plays}</td>
                        <td>${f.likes} ‚ù§Ô∏è</td>
                    </tr>
                `).join("")); const P = document.getElementById("top-users-list"); P && (!t.top_users || t.top_users.length === 0 ? P.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 1rem;">No users active yet</div>' : P.innerHTML = t.top_users.slice(0, 10).map(f => `
                    <div class="user-item" style="cursor: pointer" onclick="viewUser('${f.id}')">
                        <div class="user-avatar">${(f.name || "?").charAt(0)}</div>
                        <div class="user-info">
                            <div class="user-name">${f.name || "Unknown"}</div>
                            <div class="user-stats">${f.plays || 0} plays ‚Ä¢ ${f.total_likes || 0} likes</div>
                        </div>
                    </div>
                `).join("")); const j = { "insight-liked-genre": (n = (e = t.top_liked_genres) == null ? void 0 : e[0]) == null ? void 0 : n.name, "insight-liked-artist": (i = (s = t.top_liked_artists) == null ? void 0 : s[0]) == null ? void 0 : i.name, "insight-liked-song": (o = t.top_liked_songs) != null && o[0] ? `${t.top_liked_songs[0].title} by ${t.top_liked_songs[0].artist}` : null, "insight-played-genre": (r = (a = t.top_played_genres) == null ? void 0 : a[0]) == null ? void 0 : r.name, "insight-played-artist": (v = (l = t.top_played_artists) == null ? void 0 : l[0]) == null ? void 0 : v.name }; for (const [f, U] of Object.entries(j)) { const G = document.getElementById(f); G && (G.textContent = U || "-") } const A = document.getElementById("useful-users-list"); A && (!t.top_useful_users || t.top_useful_users.length === 0 ? A.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 1rem;">No useful activity yet</div>' : A.innerHTML = t.top_useful_users.map(f => `
                    <div class="user-item">
                        <div class="user-avatar" style="background: var(--gradient-2)">${(f.username || "?").charAt(0)}</div>
                        <div class="user-info">
                            <div class="user-name">${f.username || "Unknown"}</div>
                            <div class="user-stats">${f.score || 0} helpfulness points</div>
                        </div>
                    </div>
                `).join("")), Nt(t), d.value !== "global" && me(t)
        } catch (y) { console.error("Error updating analytics", y) }
    } let u = {}; function Dt(t) { if (!window.Chart) return; const e = { primary: "#8b5cf6", secondary: "#ec4899", tertiary: "#06b6d4", text: "#64748b" }, n = document.getElementById("plays-chart"); n && (u.plays && u.plays.destroy(), u.plays = new Chart(n, { type: "line", data: { labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"], datasets: [{ label: "Plays", data: t.playback_trends || [10, 25, 15, 30, 45, 20, 35], borderColor: e.primary, backgroundColor: "rgba(139, 92, 246, 0.1)", fill: !0, tension: .4 }] }, options: { responsive: !0, maintainAspectRatio: !1, plugins: { legend: { display: !1 } }, scales: { y: { grid: { color: "rgba(255,255,255,0.05)" }, ticks: { color: e.text } }, x: { grid: { display: !1 }, ticks: { color: e.text } } } } })); const s = document.getElementById("genres-chart"); if (s) { u.genres && u.genres.destroy(); const a = (t.top_played_genres || []).slice(0, 5); u.genres = new Chart(s, { type: "doughnut", data: { labels: a.map(r => r.name || "Unknown"), datasets: [{ data: a.map(r => r.plays || 0), backgroundColor: [e.primary, e.secondary, e.tertiary, "#f59e0b", "#10b981"], borderWidth: 0 }] }, options: { responsive: !0, maintainAspectRatio: !1, plugins: { legend: { position: "right", labels: { color: e.text, padding: 20 } } } } }) } const i = document.getElementById("server-plays-chart"); i && (u.serverPlays && u.serverPlays.destroy(), u.serverPlays = new Chart(i, { type: "line", data: { labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"], datasets: [{ label: "Server Plays", data: t.playback_trends || [0, 0, 0, 0, 0, 0, 0], borderColor: e.secondary, backgroundColor: "rgba(236, 72, 153, 0.1)", fill: !0, tension: .4 }] }, options: { responsive: !0, maintainAspectRatio: !1, plugins: { legend: { display: !1 } }, scales: { y: { grid: { color: "rgba(255,255,255,0.05)" }, ticks: { color: e.text } }, x: { grid: { display: !1 }, ticks: { color: e.text } } } } })); const o = document.getElementById("peak-chart"); o && (u.peak && u.peak.destroy(), u.peak = new Chart(o, { type: "bar", data: { labels: Array.from({ length: 24 }, (a, r) => `${r}h`), datasets: [{ label: "Plays", data: t.peak_hours || Array(24).fill(0), backgroundColor: e.tertiary, borderRadius: 4 }] }, options: { responsive: !0, maintainAspectRatio: !1, plugins: { legend: { display: !1 } }, scales: { y: { grid: { color: "rgba(255,255,255,0.05)" }, ticks: { color: e.text } }, x: { grid: { display: !1 }, ticks: { color: e.text, font: { size: 9 } } } } } })) } function Nt(t) { if (t) { if (u.plays && t.playback_trends && (u.plays.data.datasets[0].data = t.playback_trends, u.plays.update()), u.genres && t.top_played_genres) { const e = t.top_played_genres.slice(0, 5); u.genres.data.labels = e.map(n => n.name), u.genres.data.datasets[0].data = e.map(n => n.plays), u.genres.update() } u.peak && t.peak_hours && (u.peak.data.datasets[0].data = t.peak_hours, u.peak.update()) } } function me(t) { u.serverPlays && t.playback_trends && (u.serverPlays.data.datasets[0].data = t.playback_trends, u.serverPlays.update()) } async function ot() { try { let t = p.songs; d.value !== "global" && (t += `?guild_id=${d.value}`); const n = await (await fetch(t)).json(); ve(n.songs || []) } catch (t) { console.error(t) } } function ve(t) {
        const e = document.getElementById("songs-list"); if (e) {
            if (t.length === 0) { e.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-muted);">No songs found</td></tr>'; return } e.innerHTML = t.map(n => {
                let s = "-"; if (n.duration_seconds) { const o = Math.floor(n.duration_seconds / 60), a = n.duration_seconds % 60; s = `${o}:${a.toString().padStart(2, "0")}` } let i = n.played_at ? new Date(n.played_at).toLocaleString() : "Never"; return `
            <tr>
                <td>${n.title}</td>
                <td>${n.artist_name}</td>
                <td>${n.release_year || "-"}</td>
                <td>${s}</td>
                <td>${n.genre || "-"}</td>
                <td><span class="user-list" style="cursor: pointer" onclick="viewUser('${n.requested_by_id}')">${n.requested_by || "-"}</span></td>
                <td><span class="user-list liked">${n.liked_by || "-"}</span></td>
                <td><span class="user-list disliked">${n.disliked_by || "-"}</span></td>
                <td>${i}</td>
            </tr>
        `}).join("")
        }
    } async function ge() { try { let t = p.users; d.value !== "global" && (t += `?guild_id=${d.value}`); const n = await (await fetch(t)).json(); ye(n.users || []) } catch (t) { console.error(t) } } function ye(t) {
        const e = document.getElementById("users-directory"); if (e) {
            if (t.length === 0) { e.innerHTML = '<div style="text-align: center; color: var(--text-muted);">No users found</div>'; return } e.innerHTML = t.map(n => `
        <div class="user-item" style="cursor: pointer" onclick="viewUser('${n.id}')">
            <div class="user-avatar">${(n.username || "?").charAt(0)}</div>
            <div class="user-info">
                <div class="user-name">${n.username || "Unknown"}</div>
                <div class="user-stats">${n.formatted_id || n.discord_id || "ID: " + n.id}</div>
            </div>
            <div class="user-metrics" style="margin-left: auto; text-align: right; font-size: 0.8rem; color: var(--text-muted);">
                <div>${n.reactions || 0} reactions</div>
                <div>${n.playlists || 0} playlists</div>
            </div>
        </div>
    `).join("")
        }
    } async function qt() { try { let t = p.library; d.value !== "global" && (t += `?guild_id=${d.value}`); const n = await (await fetch(t)).json(); q.value = n.library || [], M.value = 1, Ot() } catch (t) { console.error(t) } } function Ot() {
        const t = document.getElementById("library-list"), e = document.getElementById("library-pagination"); if (!t || !e) return; if (q.value.length === 0) { t.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted);">Library is empty</td></tr>', e.innerHTML = ""; return } const n = (M.value - 1) * et, s = n + et, i = q.value.slice(n, s); t.innerHTML = i.map(a => {
            let r = a.last_added ? new Date(a.last_added).toLocaleDateString() : "-"; const l = { request: "üì® Request", like: "‚ù§Ô∏è Like", import: "üì• Import" }, v = (a.sources || "").split(",").map(y => l[y] || y).join(", "); return `
            <tr>
                <td>${a.title}</td>
                <td>${a.artist_name}</td>
                <td>${a.release_year || "-"}</td>
                <td>${a.genre || "-"}</td>
                <td>${v}</td>
                <td><span class="user-list">${a.contributors || "-"}</span></td>
                <td>${r}</td>
            </tr>
        `}).join(""); const o = Math.ceil(q.value.length / et); e.innerHTML = `
        <button class="page-btn" ${M.value === 1 ? "disabled" : ""} onclick="changeLibraryPage(-1)">Previous</button>
        <span class="page-info">Page ${M.value} of ${o} (${q.value.length} items)</span>
        <button class="page-btn" ${M.value === o ? "disabled" : ""} onclick="changeLibraryPage(1)">Next</button>
    `} function pe(t) { M.value += t, document.getElementById("library-table").scrollIntoView({ behavior: "smooth", block: "start" }) } function he(t, e) { $.value = e, document.querySelectorAll(".user-item").forEach(n => n.classList.remove("active")), t && t.currentTarget && t.currentTarget.classList.add("active") } function _e(t) { $.value && fetch(`/api/guilds/${$.value}/control/${t}`, { method: "POST" }).then(() => setTimeout(it, 200)) } function Z(t) { document.querySelectorAll(".tab").forEach(s => s.classList.remove("active")); const e = document.querySelector(`[data-tab="${t}"]`); e && e.classList.add("active"), document.querySelectorAll(".tab-content").forEach(s => s.style.display = "none"); const n = document.getElementById(`tab-${t}`); n && (n.style.display = "block"), t === "settings" && we() } async function at(t, e = "dashboard") { if (d.value = t, t === "global" ? (document.body.classList.remove("view-server"), document.body.classList.add("view-global")) : (document.body.classList.remove("view-global"), document.body.classList.add("view-server")), document.querySelectorAll(".server-nav-item").forEach(n => { var s; n.classList.remove("active"), t === "global" && n.textContent.includes("Global") && n.classList.add("active"), (s = n.getAttribute("onclick")) != null && s.includes(`'${t}'`) && n.classList.add("active") }), t === "global") { Tt(), Z(e); const n = document.getElementById("stat-guilds"); n && (n.nextElementSibling.textContent = "Servers") } else try { const s = await (await fetch(p.guild(t))).json(), i = document.getElementById("stat-guilds"); i && (i.textContent = s.queue_size || 0, i.nextElementSibling.textContent = "In Queue"), Z(e) } catch (n) { console.error(t, n) } } function be() { at("global", "settings") } async function we() { var s, i, o, a, r, l, v, y, L, O; const t = document.getElementById("settings-title"), e = document.getElementById("settings-global"), n = document.getElementById("settings-server"); if (d.value === "global") { t && (t.textContent = "‚öôÔ∏è Global Settings"), e && (e.style.display = "block"), n && (n.style.display = "none"); try { const _ = await (await fetch(p.settings_global)).json(), k = document.getElementById("setting-max-servers-tab"); k && (k.value = _.max_concurrent_servers || ""); const b = document.getElementById("setting-test-mode"); b && (b.checked = !!_.test_mode); const w = document.getElementById("setting-test-duration"); w && (w.value = _.playback_duration || 30) } catch (I) { console.error(I) } } else { t && (t.textContent = "‚öôÔ∏è Server Settings"), e && (e.style.display = "none"), n && (n.style.display = "block"); try { const _ = await (await fetch(p.settings(d.value))).json(), k = document.getElementById("setting-pre-buffer"); k && (k.checked = !!_.pre_buffer); const b = document.getElementById("setting-buffer-amount"); if (b) { b.value = _.buffer_amount || 1; const Vt = document.getElementById("buffer-val"); Vt && (Vt.textContent = b.value) } const w = document.getElementById("setting-max-duration"); w && (w.value = _.max_song_duration || 6); const P = document.getElementById("setting-ephemeral-duration"); P && (P.value = _.ephemeral_duration || 10); const j = _.discovery_weights || { similar: 25, artist: 25, wildcard: 25, library: 25 }, A = document.getElementById("weight-similar"); A && (A.value = j.similar || 0); const f = document.getElementById("weight-artist"); f && (f.value = j.artist || 0); const U = document.getElementById("weight-wildcard"); U && (U.value = j.wildcard || 0); const G = document.getElementById("weight-library"); G && (G.value = j.library || 0), xe(); const D = _.metadata_config || { strategy: "fallback", engines: { spotify: { enabled: !0, priority: 1 }, discogs: { enabled: !0, priority: 2 }, musicbrainz: { enabled: !0, priority: 3 } } }, Wt = document.getElementById("meta-strategy"); Wt && (Wt.value = D.strategy || "fallback"); const zt = document.getElementById("meta-discogs-enabled"); zt && (zt.checked = ((i = (s = D.engines) == null ? void 0 : s.discogs) == null ? void 0 : i.enabled) !== !1); const Rt = document.getElementById("meta-discogs-prio"); Rt && (Rt.value = ((a = (o = D.engines) == null ? void 0 : o.discogs) == null ? void 0 : a.priority) || 2); const Jt = document.getElementById("meta-mb-enabled"); Jt && (Jt.checked = ((l = (r = D.engines) == null ? void 0 : r.musicbrainz) == null ? void 0 : l.enabled) !== !1); const Zt = document.getElementById("meta-mb-prio"); Zt && (Zt.value = ((y = (v = D.engines) == null ? void 0 : v.musicbrainz) == null ? void 0 : y.priority) || 3); const Qt = document.getElementById("meta-spotify-prio"); Qt && (Qt.value = ((O = (L = D.engines) == null ? void 0 : L.spotify) == null ? void 0 : O.priority) || 1) } catch (I) { console.error(I) } } } async function Ee() { try { const e = await (await fetch(p.notifications)).json(); Gt(e.notifications || []) } catch (t) { console.error(t) } } function Gt(t) {
        const e = document.getElementById("notif-list"), n = document.getElementById("notif-dot"); if (e) {
            if (t.length === 0) { e.innerHTML = '<div class="notif-item" style="color: var(--text-muted); text-align: center;">No new notifications</div>', n && (n.style.display = "none"); return } n && (n.style.display = "block"), e.innerHTML = t.map(s => `
        <div class="notif-item">
            <div style="font-weight: 500; color: var(--${s.level === "error" ? "error" : s.level === "warning" ? "warning" : "text-primary"})">${s.level.toUpperCase()}</div>
            <div>${s.message}</div>
            <div class="notif-time">${new Date(s.created_at * 1e3).toLocaleString()}</div>
        </div>
    `).join("")
        }
    } function $e() { dd && dd.classList.toggle("show") } async function Ie() { if (!d.value || d.value === "global") return; const t = d.value, e = document.getElementById("setting-pre-buffer").checked, n = document.getElementById("setting-buffer-amount").value, s = document.getElementById("setting-max-duration").value, i = document.getElementById("setting-ephemeral-duration").value, o = { similar: parseInt(document.getElementById("weight-similar").value) || 0, artist: parseInt(document.getElementById("weight-artist").value) || 0, wildcard: parseInt(document.getElementById("weight-wildcard").value) || 0, library: parseInt(document.getElementById("weight-library").value) || 0 }, a = { strategy: document.getElementById("meta-strategy").value, engines: { spotify: { enabled: !0, priority: parseInt(document.getElementById("meta-spotify-prio").value) || 1 }, discogs: { enabled: document.getElementById("meta-discogs-enabled").checked, priority: parseInt(document.getElementById("meta-discogs-prio").value) || 2 }, musicbrainz: { enabled: document.getElementById("meta-mb-enabled").checked, priority: parseInt(document.getElementById("meta-mb-prio").value) || 3 } } }; try { (await fetch(p.settings(t), { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ pre_buffer: e, buffer_amount: parseInt(n), max_song_duration: parseInt(s), ephemeral_duration: parseInt(i), discovery_weights: o, metadata_config: a }) })).ok ? alert("Settings saved!") : alert("Failed to save settings") } catch (r) { console.error(r), alert("Error saving settings") } } async function ke() { const t = document.getElementById("setting-max-servers-tab").value, e = document.getElementById("setting-test-mode").checked, n = document.getElementById("setting-test-duration").value; try { (await fetch(p.settings_global, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ max_concurrent_servers: t ? parseInt(t) : null, test_mode: e, playback_duration: n ? parseInt(n) : 30 }) })).ok ? alert("Global settings saved!") : alert("Failed to save global settings") } catch (s) { console.error(s), alert("Error saving global settings") } } function xe() { const t = parseInt(document.getElementById("weight-similar").value) || 0, e = parseInt(document.getElementById("weight-artist").value) || 0, n = parseInt(document.getElementById("weight-wildcard").value) || 0, s = parseInt(document.getElementById("weight-library").value) || 0, i = t + e + n + s, o = document.getElementById("weights-total"); o && (o.textContent = i, o.style.color = i === 100 ? "var(--text-primary)" : "var(--warning)"); const a = document.getElementById("weight-error"); a && (a.style.display = i === 100 ? "none" : "block") } function Ft(t) { if (!t) return "0s"; const e = Math.floor(t / (24 * 3600)); t %= 24 * 3600; const n = Math.floor(t / 3600); t %= 3600; const s = Math.floor(t / 60), i = t % 60; let o = []; return e > 0 && o.push(`${e}d`), n > 0 && o.push(`${n}h`), s > 0 && o.push(`${s}m`), (i > 0 || o.length === 0) && o.push(`${i}s`), o.join(" ") } Object.assign(window, { switchTab: Z, switchScope: at, control: _e, changeLibraryPage: pe, selectGuild: he, leaveGuild: ue, leaveServer: fe, saveServerSettings: Ie, saveSettingsTab: ke, toggleNotifications: $e, viewUser: Lt, openGlobalSettings: be, initCharts: Dt, updateCharts: Nt })
})();
